---
import BaseHead from '$/components/BaseHead.astro';
import Footer from '$/components/Footer.astro';
import Header from '$/components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '$/consts';
import { getCart, removeFromCart, updateQuantity, getCartTotal } from '$/lib/cart-utils';
import { getEntry } from 'astro:content';

const cartItems = getCart();
const total = getCartTotal();

// 获取商品信息用于购物车展示
const productEntries: Record<string, any> = {};
for (const item of cartItems) {
  const product = await getEntry('products', item.id);
  if (product) {
    productEntries[item.id] = product;
  }
}
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`购物车 - ${SITE_TITLE}`} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <Header />
    <main>
      <h1>购物车</h1>
      
      {cartItems.length === 0 ? (
        <p>购物车是空的</p>
      ) : (
        <div class="cart-container">
          <div class="cart-items">
            {cartItems.map((item) => {
              const product = productEntries[item.id];
              return (
                <div class="cart-item">
                  <h3>{product?.data.title || item.title}</h3>
                  <p>单价: ¥{item.price}</p>
                  <p>数量: 
                    <input 
                      type="number" 
                      min="1" 
                      value={item.quantity} 
                      onchange="updateQuantity('{item.id}', parseInt(this.value))"
                    />
                  </p>
                  <p>小计: ¥{(item.price * item.quantity).toFixed(2)}</p>
                  <button onclick="removeFromCart('{item.id}')">删除</button>
                </div>
              );
            })}
          </div>
          
          <div class="cart-summary">
            <h2>订单摘要</h2>
            <p>商品总数: {cartItems.reduce((sum, item) => sum + item.quantity, 0)}</p>
            <p>总计: ¥{total.toFixed(2)}</p>
            <button onclick="window.location.href='/checkout'">去结算</button>
          </div>
        </div>
      )}
    </main>
    <Footer />
  </body>
</html>

<style>
.cart-container {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

.cart-items {
  border-right: 1px solid #eee;
  padding-right: 20px;
}

.cart-item {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 16px;
  margin: 16px 0;
}

.cart-summary {
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 8px;
}

.cart-summary button {
  background-color: #3498db;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1.1em;
  width: 100%;
}

.cart-summary button:hover {
  background-color: #2980b9;
}
</style>
